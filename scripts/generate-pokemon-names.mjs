import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function parseArgs(argv) {
  const out = { pokesleepTool: path.join(__dirname, "../../pokesleep-tool") };
  for (let i = 2; i < argv.length; i++) {
    const a = argv[i];
    if (a === "--pokesleep-tool" && argv[i + 1]) {
      out.pokesleepTool = argv[i + 1];
      i++;
      continue;
    }
  }
  return out;
}

const args = parseArgs(process.argv);
const toolRoot = path.resolve(args.pokesleepTool);

const pokemonJsonPath = path.join(toolRoot, "src/data/pokemon.json");
const jaJsonPath = path.join(toolRoot, "src/i18n/ja.json");

if (!fs.existsSync(pokemonJsonPath)) {
  throw new Error(`pokemon.json not found: ${pokemonJsonPath}`);
}
if (!fs.existsSync(jaJsonPath)) {
  throw new Error(`ja.json not found: ${jaJsonPath}`);
}

const pokemonList = JSON.parse(fs.readFileSync(pokemonJsonPath, "utf8"));
const ja = JSON.parse(fs.readFileSync(jaJsonPath, "utf8"));

const nameDict = ja?.translation?.pokemons;
if (!nameDict || typeof nameDict !== "object") {
  throw new Error(`translation.pokemons not found in: ${jaJsonPath}`);
}

const formNameToNumber = {
  Halloween: 1,
  Holiday: 2,
  Alola: 3,
  Paldea: 4,
  "Amped": 5,
  "Low Key": 6,
  Small: 7,
  Medium: 8,
  Large: 9,
  Jumbo: 10,
};

/** key = id + (form<<12) */
const nameMap = {};
const expTypeMap = {};
const jaName2IdForms = {};
const ingredientsMap = {};
const specialtyMap = {};

for (const p of pokemonList) {
  if (!p || typeof p !== "object") continue;
  const id = Number(p.id);
  if (!Number.isFinite(id) || id <= 0) continue;
  const formStr = p.form;
  const form = formStr ? (formNameToNumber[formStr] ?? 0) : 0;
  const idForm = id + (form << 12);
  const enName = typeof p.name === "string" ? p.name : "";
  if (!enName) continue;
  const jaName = typeof nameDict[enName] === "string" ? nameDict[enName] : enName;
  nameMap[idForm] = jaName;

  const exp = Number(p.exp);
  expTypeMap[idForm] = exp === 600 || exp === 900 || exp === 1080 || exp === 1320 ? exp : 600;

  if (!jaName2IdForms[jaName]) jaName2IdForms[jaName] = [];
  jaName2IdForms[jaName].push(idForm);

  const ing1 = p.ing1?.name;
  const ing2 = p.ing2?.name;
  const ing3 = p.ing3?.name;
  if (typeof ing1 === "string" && typeof ing2 === "string") {
    ingredientsMap[idForm] = {
      a: ing1,
      b: ing2,
      c: typeof ing3 === "string" ? ing3 : null,
    };
  }

  const sp = p.specialty;
  if (sp === "Berries" || sp === "Ingredients" || sp === "Skills" || sp === "All") {
    specialtyMap[idForm] = sp;
  } else {
    specialtyMap[idForm] = "unknown";
  }
}

const outPath = path.join(__dirname, "../src/domain/pokesleep/pokemon-names.ts");
const generatedAt = new Date().toISOString();

const content =
  `// This file is auto-generated by scripts/generate-pokemon-names.mjs\n` +
  `// Source: pokesleep-tool (local)\n` +
  `// Generated at: ${generatedAt}\n\n` +
  `export const pokemonNameJaByIdForm = ${JSON.stringify(nameMap, null, 2)} as const;\n\n` +
  `export const pokemonExpTypeByIdForm = ${JSON.stringify(expTypeMap, null, 2)} as const;\n\n` +
  `export const pokemonIdFormsByNameJa = ${JSON.stringify(jaName2IdForms, null, 2)} as const;\n\n` +
  `export const pokemonIngredientsByIdForm = ${JSON.stringify(ingredientsMap, null, 2)} as const;\n\n` +
  `export const pokemonSpecialtyByIdForm = ${JSON.stringify(specialtyMap, null, 2)} as const;\n\n` +
  `export function toIdForm(pokedexId: number, form: number): number {\n` +
  `  return (pokedexId | 0) + ((form | 0) << 12);\n` +
  `}\n\n` +
  `export function getPokemonNameJa(pokedexId: number, form: number = 0): string | null {\n` +
  `  const k = String(toIdForm(pokedexId, form));\n` +
  `  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n` +
  `  const v = (pokemonNameJaByIdForm as any)[k];\n` +
  `  return typeof v === "string" ? v : null;\n` +
  `}\n\n` +
  `export function getPokemonExpType(pokedexId: number, form: number = 0): 600 | 900 | 1080 | 1320 {\n` +
  `  const k = String(toIdForm(pokedexId, form));\n` +
  `  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n` +
  `  const v = (pokemonExpTypeByIdForm as any)[k];\n` +
  `  return v === 600 || v === 900 || v === 1080 || v === 1320 ? v : 600;\n` +
  `}\n\n` +
  `export function getPokemonIngredients(pokedexId: number, form: number = 0): { a: string; b: string; c: string | null } | null {\n` +
  `  const k = String(toIdForm(pokedexId, form));\n` +
  `  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n` +
  `  const v = (pokemonIngredientsByIdForm as any)[k];\n` +
  `  if (!v || typeof v !== "object") return null;\n` +
  `  const a = typeof v.a === "string" ? v.a : null;\n` +
  `  const b = typeof v.b === "string" ? v.b : null;\n` +
  `  const c = v.c === null || typeof v.c === "string" ? v.c : null;\n` +
  `  return a && b ? { a, b, c } : null;\n` +
  `}\n\n` +
  `export type PokemonSpecialty = "Berries" | "Ingredients" | "Skills" | "All" | "unknown";\n` +
  `export function getPokemonSpecialty(pokedexId: number, form: number = 0): PokemonSpecialty {\n` +
  `  const k = String(toIdForm(pokedexId, form));\n` +
  `  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n` +
  `  const v = (pokemonSpecialtyByIdForm as any)[k];\n` +
  `  return v === "Berries" || v === "Ingredients" || v === "Skills" || v === "All" ? v : "unknown";\n` +
  `}\n\n` +
  `export function findPokemonByNameJa(nameJa: string): { pokedexId: number; form: number; expType: 600 | 900 | 1080 | 1320 } | null {\n` +
  `  const key = String(nameJa ?? "").trim();\n` +
  `  if (!key) return null;\n` +
  `  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n` +
  `  const list = (pokemonIdFormsByNameJa as any)[key];\n` +
  `  if (!Array.isArray(list) || list.length === 0) return null;\n` +
  `  // form=0 を優先、それ以外は最小idForm\n` +
  `  const sorted = [...list].sort((a, b) => {\n` +
  `    const fa = (a >> 12) & 0x3f;\n` +
  `    const fb = (b >> 12) & 0x3f;\n` +
  `    if (fa === 0 && fb !== 0) return -1;\n` +
  `    if (fb === 0 && fa !== 0) return 1;\n` +
  `    return a - b;\n` +
  `  });\n` +
  `  const idForm = Number(sorted[0]);\n` +
  `  const pokedexId = idForm & 0xfff;\n` +
  `  const form = idForm >> 12;\n` +
  `  const expType = getPokemonExpType(pokedexId, form);\n` +
  `  return { pokedexId, form, expType };\n` +
  `}\n`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, content, "utf8");
console.log(`[generate-pokemon-names] wrote: ${outPath}`);
