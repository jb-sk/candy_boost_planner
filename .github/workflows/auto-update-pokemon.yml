# ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Wikiã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æ–°è¦ãƒã‚±ãƒ¢ãƒ³ãŒã‚ã‚Œã°PRã‚’è‡ªå‹•ä½œæˆ
name: Auto Update Pokemon Data

on:
  schedule:
    # æ¯æ—¥ UTC 00:00 (JST 09:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
    # æ¯æœˆ1æ—¥ UTC 01:00 (JST 10:00) ã«å…¨ä»¶ãƒã‚§ãƒƒã‚¯
    - cron: '0 1 1 * *'
  workflow_dispatch:
    inputs:
      refresh_en_names:
        description: 'Re-fetch all English names from PokeAPI'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-pokemon-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for master data changes
        id: master_check
        run: |
          echo "=== ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å·®åˆ†ç¢ºèª ==="
          OUTPUT=$(npm run generate:master -- --non-interactive --dry-run 2>&1 || true)
          echo "$OUTPUT"

          # è¿½åŠ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$OUTPUT" | grep -q "è¿½åŠ : 0"; then
            echo "has_master_changes=false" >> $GITHUB_OUTPUT
            echo "ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãªã—"
          else
            echo "has_master_changes=true" >> $GITHUB_OUTPUT
            echo "ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚ã‚Š"
          fi

          # ã‚µãƒãƒªãƒ¼ã‚’ä¿å­˜
          echo 'master_summary<<EOF' >> $GITHUB_OUTPUT
          echo "$OUTPUT" | grep -A 100 "entries:" | head -50 >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Update master data
        if: steps.master_check.outputs.has_master_changes == 'true'
        run: |
          echo "=== ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–° ==="
          npm run generate:master -- --non-interactive

      - name: Update English names and check changes
        id: en_names
        run: |
          echo "=== è‹±èªåå–å¾—ï¼ˆPokeAPIï¼‰==="

          # æœˆ1æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« or æ‰‹å‹•ã§ --refresh æŒ‡å®šæ™‚ã¯å…¨ä»¶å†å–å¾—
          DAY_OF_MONTH=$(date -u +%d)
          REFRESH_REQUESTED="${{ github.event.inputs.refresh_en_names }}"

          if [ "$DAY_OF_MONTH" = "01" ] || [ "$REFRESH_REQUESTED" = "true" ]; then
            echo "å…¨ä»¶å†å–å¾—ãƒ¢ãƒ¼ãƒ‰ï¼ˆ--refreshï¼‰"
            EN_OUTPUT=$(npm run generate:pokemon-en-names -- --refresh 2>&1)
          else
            echo "é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰"
            EN_OUTPUT=$(npm run generate:pokemon-en-names 2>&1)
          fi
          EN_EXIT_CODE=$?
          echo "$EN_OUTPUT"

          # è‹±èªåå–å¾—ãŒå¤±æ•—ã—ãŸå ´åˆã¯ä¸­æ–­
          if [ $EN_EXIT_CODE -ne 0 ]; then
            echo "âŒ è‹±èªåå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "en_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "en_success=true" >> $GITHUB_OUTPUT

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ[SUMMARY]è¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼‰
          if echo "$EN_OUTPUT" | grep -q "\[SUMMARY\] has_changes=true"; then
            echo "has_en_changes=true" >> $GITHUB_OUTPUT
            echo "è‹±èªåå¤‰æ›´ã‚ã‚Š"
          else
            echo "has_en_changes=false" >> $GITHUB_OUTPUT
            echo "è‹±èªåå¤‰æ›´ãªã—"
          fi

          # ã‚µãƒãƒªãƒ¼ã‚’ä¿å­˜ï¼ˆè¿½åŠ /å¤‰æ›´/å‰Šé™¤ã®è¡Œï¼‰
          echo 'en_summary<<EOF' >> $GITHUB_OUTPUT
          echo "$EN_OUTPUT" | grep -E "^(âœ…|ğŸ“|ğŸ—‘ï¸|å¤‰æ›´ãªã—)" | head -30 >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Check if any changes exist
        id: final_check
        run: |
          MASTER_CHANGES="${{ steps.master_check.outputs.has_master_changes }}"
          EN_CHANGES="${{ steps.en_names.outputs.has_en_changes }}"

          echo "Master changes: $MASTER_CHANGES"
          echo "EN names changes: $EN_CHANGES"

          if [ "$MASTER_CHANGES" = "true" ] || [ "$EN_CHANGES" = "true" ]; then
            echo "has_any_changes=true" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã‚ã‚Š â†’ PRä½œæˆ"
          else
            echo "has_any_changes=false" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ãªã— â†’ PRä½œæˆã‚¹ã‚­ãƒƒãƒ—"
          fi


      # ãƒ†ã‚¹ãƒˆè¨­å®šï¼ˆtest-config.json ã® latestPokemon.nameï¼‰ã¯
      # generate-pokemon-master.mjs å†…ã§è¿½åŠ ãƒã‚±ãƒ¢ãƒ³æ¤œå‡ºæ™‚ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹

      - name: Build
        if: steps.final_check.outputs.has_any_changes == 'true'
        run: npm run build

      - name: Create Pull Request
        if: steps.final_check.outputs.has_any_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°"
          title: "ğŸ„ ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°"
          body: |
            ## è‡ªå‹•æ›´æ–°: ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿

            ã“ã®PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### å¤‰æ›´å†…å®¹ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰
            ```
            ${{ steps.master_check.outputs.master_summary }}
            ```

            ### å¤‰æ›´å†…å®¹ï¼ˆè‹±èªåï¼‰
            ```
            ${{ steps.en_names.outputs.en_summary }}
            ```

            ### âš ï¸ ç¢ºèªäº‹é …
            - 600æ—ãƒ»æº–ä¼ãƒ»å¹» (900/1080/1320) ã¯æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„
            - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚©ãƒ¼ãƒ åãŒã‚ã‚‹å ´åˆã¯è‹±è¨³ã‚’ç¢ºèªã—ã¦ãã ã•ã„

            ### æ‰‹å‹•ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ
            1. ã“ã®PRã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            2. `npm run generate:master` ã‚’å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã€expType ã‚’è¨­å®š
            3. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥

            ---
            *Generated by [Auto Update Pokemon Data](.github/workflows/auto-update-pokemon.yml)*
          branch: auto-update/pokemon-data
          delete-branch: true
          labels: |
            automated
            data-update
