# ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Wikiã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æ–°è¦ãƒã‚±ãƒ¢ãƒ³ãŒã‚ã‚Œã°PRã‚’è‡ªå‹•ä½œæˆ
name: Auto Update Pokemon Data

on:
  schedule:
    # æ¯æ—¥ UTC 00:00 (JST 09:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write
  pull-requests: write

jobs:
  update-pokemon-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run dry-run to check for changes
        id: dryrun
        run: |
          echo "=== ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œ ==="
          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã§å·®åˆ†ã‚’ç¢ºèª
          OUTPUT=$(npm run generate:master -- --non-interactive --dry-run 2>&1 || true)
          echo "$OUTPUT"

          # è¿½åŠ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$OUTPUT" | grep -q "è¿½åŠ : 0"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ãªã—"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã‚ã‚Š"
          fi

          # ã‚µãƒãƒªãƒ¼ã‚’ä¿å­˜
          echo 'summary<<EOF' >> $GITHUB_OUTPUT
          echo "$OUTPUT" | grep -A 100 "entries:" | head -50 >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Run update if changes detected
        if: steps.dryrun.outputs.has_changes == 'true'
        run: |
          echo "=== æ›´æ–°å®Ÿè¡Œ ==="
          npm run generate:master -- --non-interactive
          npm run generate:pokemon-en-names -- --force
          npm run build

      - name: Create Pull Request
        if: steps.dryrun.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°"
          title: "ğŸ„ ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°"
          body: |
            ## è‡ªå‹•æ›´æ–°: ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿

            ã“ã®PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### å¤‰æ›´å†…å®¹
            ```
            ${{ steps.dryrun.outputs.summary }}
            ```

            ### âš ï¸ ç¢ºèªäº‹é …
            - æ–°è¦ãƒã‚±ãƒ¢ãƒ³ã® **expType ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (600)** ã§ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™
            - ä¼èª¬ãƒ»æº–ä¼èª¬ (900/1080/1320) ãŒã‚ã‚‹å ´åˆã¯æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„
            - æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ åãŒã‚ã‚‹å ´åˆã¯è‹±è¨³ã‚’ç¢ºèªã—ã¦ãã ã•ã„

            ### æ‰‹å‹•ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ
            1. ã“ã®PRã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            2. `npm run generate:master` ã‚’å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã€expType ã‚’è¨­å®š
            3. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥

            ---
            *Generated by [Auto Update Pokemon Data](.github/workflows/auto-update-pokemon.yml)*
          branch: auto-update/pokemon-data
          delete-branch: true
          labels: |
            automated
            data-update
