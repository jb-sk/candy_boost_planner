---
description: リベース/マージ支援ワークフローの全体像と注意点をエージェントに読み込ませる
---

# 安全なGitマージ/リベース支援ガイド (/rebase-help)

このワークフローを実行したエージェントは、以下のガイドラインを熟読し、プロジェクト推奨の「安全なリベース運用」を理解すること。

---

## 🛠️ ワークフローの全体像

従来の「リベースしてマージ」を一発で行うのではなく、以下の**サンドイッチ構造**で作業を行う。

1.  **🤖 エージェント: `/rebase-pre` （準備）**
    *   作業環境を掃除し、mainから生やしたクリーンなブランチに、必要なコミットだけを移植（Cherry-pick）する。
    *   *成果物*: マージ作業専用の一時ブランチ (`temp/...`)

2.  **👤 ユーザー: マージ作業**
    *   用意された一時ブランチを使って、コンフリクト解消や機能修正を行い、`main` へのPR作成・マージを行う。
    *   *成果物*: バグ修正などが取り込まれ、進んだ `main`

3.  **🤖 エージェント: `/rebase-post` （仕上げ）**
    *   取り残された元の作業ブランチを、進んだ `main` の上にリベース（積み直し）して追従させる。最後に元の作業環境（スタッシュ）を復元する。
    *   *成果物*: 最新の `main` に追従した作業ブランチ

---

## 💡 なぜこの手順なのか？

### 理由1: "Git Ghost"（亡霊コンフリクト）の防止
過去に、`.gitignore` で無視されているUntrackedファイルが原因で、リベース中にありもしないコンフリクトが発生する事故があった。
このワークフローでは、**「作業前に必ず `stash --include-untracked` で掃除する」** ことと、**「RebaseではなくCherry-pickでブランチを作る」** ことで、この問題を物理的に回避している。

### 理由2: 人間と機械の分業
*   **機械（エージェント）が得意なこと**: コマンド操作、退避・復元、ブランチ作成などの定型作業。
*   **人間が得意なこと**: コンフリクトの論理的な解消、マージする/しないの判断、PRの作成。
この2つを明確に分けることで、人間は「判断」に集中できる。

---

## 💬 ユーザーからの指示への対応

### ① マージ作業を始めたいと言われたら
`/rebase-pre` の手順を実行し、マージ作業用のクリーンなブランチを準備する。
（※取り込みたいコミット範囲が不明確な場合は、必ずユーザーに確認すること）

### ② マージが終わって、元のブランチを最新化したいと言われたら
`/rebase-post` の手順を実行し、元のブランチを最新のmainに追従させる。

---

## 📂 関連ファイル
*   **ワークフロー定義ファイル**: `.agent/workflows/rebase.md`
    *   実際のエージェント向け実行手順が書かれている。
    *   `/rebase-pre` および `/rebase-post` の具体的なコマンド手順はこのファイルを参照すること。
*   **技術的背景資料**: `_local/git_rebase_anomaly_insight.md`
    *   なぜこの問題が起きたのかの詳細な解析記録。
